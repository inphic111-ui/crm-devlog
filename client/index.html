<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM DevLog - é–‹ç™¼æ—¥èªŒå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #1e293b;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            color: #e2e8f0;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.1);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #f1f5f9;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-connected {
            background: #10b981;
            color: #ecfdf5;
        }

        .status-error {
            background: #ef4444;
            color: #fef2f2;
        }

        .status-disconnected {
            background: #6b7280;
            color: #f3f4f6;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #334155;
            font-size: 13px;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #94a3b8;
        }

        .info-value {
            color: #f1f5f9;
            font-weight: 500;
        }

        .logs-container {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
            background: #0f172a;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
        }

        .log-time {
            color: #94a3b8;
            font-size: 12px;
        }

        .log-level {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: 600;
            margin-right: 8px;
            font-size: 11px;
        }

        .log-info {
            background: #3b82f6;
            color: #dbeafe;
        }

        .log-warn {
            background: #f59e0b;
            color: #fef3c7;
        }

        .log-error {
            background: #ef4444;
            color: #fee2e2;
        }

        .log-message {
            color: #e2e8f0;
        }

        .button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .button:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .button-secondary {
            background: #475569;
        }

        .button-secondary:hover {
            background: #64748b;
        }

        .button-danger {
            background: #ef4444;
        }

        .button-danger:hover {
            background: #dc2626;
        }

        .button-success {
            background: #10b981;
        }

        .button-success:hover {
            background: #059669;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        select, textarea {
            padding: 10px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            resize: vertical;
        }

        select {
            flex: 1;
            min-width: 150px;
        }

        .table-container {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: #0f172a;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #334155;
            font-weight: 600;
            color: #f1f5f9;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #334155;
            color: #cbd5e1;
        }

        tr:hover {
            background: #334155;
        }

        .message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .message-success {
            background: #10b98130;
            border: 1px solid #10b981;
            color: #a7f3d0;
        }

        .message-error {
            background: #ef444430;
            border: 1px solid #ef4444;
            color: #fca5a5;
        }

        .message-info {
            background: #3b82f630;
            border: 1px solid #3b82f6;
            color: #93c5fd;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #667eea;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .pagination {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 8px 12px;
            background: #475569;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .pagination button:hover {
            background: #64748b;
        }

        .pagination button.active {
            background: #667eea;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                gap: 5px;
            }

            .nav-tab {
                padding: 10px 15px;
                font-size: 12px;
            }

            h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š CRM DevLog</h1>
            <p class="subtitle">é–‹ç™¼æ—¥èªŒå·¥å…· - å¯¦æ™‚ç›£æ§ã€æ•¸æ“šé·ç§»ã€éŒ¯èª¤è¿½è¹¤</p>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">ğŸ“ˆ å„€è¡¨æ¿</button>
            <button class="nav-tab" onclick="switchTab('logs')">ğŸ“ æ—¥èªŒ</button>
            <button class="nav-tab" onclick="switchTab('database')">ğŸ—„ï¸ æ•¸æ“šåº«</button>
            <button class="nav-tab" onclick="switchTab('migrate')">ğŸ”„ æ•¸æ“šé·ç§»</button>
        </div>

        <!-- å„€è¡¨æ¿ -->
        <div id="dashboard" class="content active">
            <div class="grid" id="environmentsGrid"></div>
        </div>

        <!-- æ—¥èªŒ -->
        <div id="logs" class="content">
            <div class="input-group">
                <select id="logLevel" onchange="refreshLogs()">
                    <option value="all">æ‰€æœ‰ç´šåˆ¥</option>
                    <option value="info">ä¿¡æ¯</option>
                    <option value="warn">è­¦å‘Š</option>
                    <option value="error">éŒ¯èª¤</option>
                </select>
                <button class="button" onclick="refreshLogs()">ğŸ”„ åˆ·æ–°</button>
                <button class="button button-danger" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥èªŒ</button>
            </div>
            <div class="logs-container" id="logsContainer"></div>
            <div class="pagination" id="logsPagination"></div>
        </div>

        <!-- æ•¸æ“šåº« -->
        <div id="database" class="content">
            <div class="input-group">
                <select id="dbEnv" onchange="loadTables()">
                    <option value="offline">OFFLINE (æ¸¬è©¦)</option>
                    <option value="online">ONLINE (æ­£å¼)</option>
                </select>
                <button class="button" onclick="loadTables()">ğŸ“‹ åŠ è¼‰è¡¨æ ¼</button>
            </div>

            <div id="dbMessage"></div>

            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">è¡¨æ ¼åˆ—è¡¨</h3>
                <div id="tablesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">SQL æŸ¥è©¢</h3>
                <div class="input-group">
                    <textarea id="sqlQuery" placeholder="SELECT * FROM customers LIMIT 10;"></textarea>
                </div>
                <button class="button" onclick="executeSql()">â–¶ï¸ åŸ·è¡ŒæŸ¥è©¢</button>
            </div>

            <div id="queryResult"></div>
        </div>

        <!-- æ•¸æ“šé·ç§» -->
        <div id="migrate" class="content">
            <h2 style="margin-bottom: 20px;">ğŸ”„ æ•¸æ“šé·ç§»å·¥å…·</h2>
            <p style="margin-bottom: 20px; color: #94a3b8;">
                å°‡æ•¸æ“šå¾ OFFLINE (æ¸¬è©¦) é·ç§»åˆ° ONLINE (æ­£å¼)
            </p>

            <div class="input-group">
                <button class="button button-success" onclick="migrateAll()">
                    âš¡ é·ç§»æ‰€æœ‰è¡¨æ ¼
                </button>
                <button class="button" onclick="verifyAll()">
                    âœ“ é©—è­‰æ‰€æœ‰è¡¨æ ¼
                </button>
            </div>

            <div id="migrateMessage"></div>


                <h3>æŒ‰å®¢æˆ¶é¸æ“‡é·ç§»</h3>
                <div style="margin-bottom: 15px;">
                    <label><strong>é¸æ“‡ç’°å¢ƒï¼š</strong></label>
                    <select id="selectDatabase" style="width: 200px; padding: 8px;">
                        <option value="offline">OFFLINE (æ¸¬è©¦)</option>
                        <option value="online">ONLINE (æ­£å¼)</option>
                    </select>
                    <button onclick="loadCustomerList()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">åŠ è¼‰å®¢æˆ¶åˆ—è¡¨</button>
                </div>

                <div id="customerListContainer" style="margin-bottom: 15px; display: none;">
                    <div style="margin-bottom: 10px;">
                        <button onclick="selectAllCustomers()" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">å…¨é¸</button>
                        <button onclick="deselectAllCustomers()" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">åé¸</button>
                        <span id="selectedCount" style="color: #666; font-weight: bold;">å·²é¸æ“‡: 0 å€‹å®¢æˆ¶</span>
                    </div>

                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                        <table id="customerTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                    <th style="padding: 10px; text-align: left; width: 40px;">é¸æ“‡</th>
                                    <th style="padding: 10px; text-align: left;">ID</th>
                                    <th style="padding: 10px; text-align: left;">åç¨±</th>
                                    <th style="padding: 10px; text-align: left;">éƒµç®±</th>
                                    <th style="padding: 10px; text-align: left;">å…¬å¸</th>
                                    <th style="padding: 10px; text-align: left;">ç‹€æ…‹</th>
                                </tr>
                            </thead>
                            <tbody id="customerTableBody">
                                <tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">åŠ è¼‰ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 15px;">
                        <button onclick="migrateSelectedCustomers()" style="padding: 10px 20px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">é·ç§»é¸ä¸­çš„å®¢æˆ¶</button>
                        <button onclick="mergeSelectedCustomers()" style="padding: 10px 20px; background: #9C27B0; color: white; border: none; border-radius: 4px; cursor: pointer;">åˆä½µé¸ä¸­çš„å®¢æˆ¶</button>
                    </div>

                    <div id="selectResult" style="margin-top: 15px;"></div>
                </div>

            <h3 style="margin-top: 30px; margin-bottom: 15px;">å–®å€‹è¡¨æ ¼é·ç§»</h3>
            <div class="input-group">
                <select id="migrateTable">
                    <option value="">é¸æ“‡è¡¨æ ¼...</option>
                </select>
                <button class="button" onclick="migrateTable()">é·ç§»æ­¤è¡¨æ ¼</button>
                <button class="button" onclick="mergeTable()">åˆä½µæ­¤è¡¨æ ¼</button>
                <button class="button" onclick="verifyTable()">é©—è­‰æ­¤è¡¨æ ¼</button>
            </div>

            <div id="migrateResult"></div>
        </div>
    </div>

    <script>
        let currentLogPage = 0;
        const logsPerPage = 50;

        async function switchTab(tabName) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') {
                loadEnvironments();
            } else if (tabName === 'logs') {
                refreshLogs();
            } else if (tabName === 'database') {
                loadTables();
            } else if (tabName === 'migrate') {
                loadMigrateTables();
            }
        }

        async function loadEnvironments() {
            try {
                const response = await fetch('/api/environments');
                const environments = await response.json();
                const grid = document.getElementById('environmentsGrid');
                grid.innerHTML = '';

                for (const [env, info] of Object.entries(environments)) {
                    const statusClass = `status-${info.status}`;
                    const html = `
                        <div class="card">
                            <div class="card-title">${info.name}</div>
                            <div class="status-badge ${statusClass}">${info.status.toUpperCase()}</div>
                            <div class="info-row">
                                <span class="info-label">ç‹€æ…‹</span>
                                <span class="info-value">${info.status}</span>
                            </div>
                            ${info.dbInfo ? `
                                <div class="info-row">
                                    <span class="info-label">é€£æ¥æ± </span>
                                    <span class="info-value">${info.dbInfo.poolSize}/${info.dbInfo.idleCount}</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">ç‰ˆæœ¬</span>
                                    <span class="info-value">${info.dbInfo.version.split(',')[0]}</span>
                                </div>
                            ` : ''}
                            ${info.error ? `
                                <div class="info-row" style="color: #fca5a5;">
                                    <span class="info-label">éŒ¯èª¤</span>
                                    <span class="info-value">${info.error}</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    grid.innerHTML += html;
                }
            } catch (err) {
                console.error('åŠ è¼‰ç’°å¢ƒå¤±æ•—:', err);
            }
        }

        async function refreshLogs() {
            currentLogPage = 0;
            loadLogs();
        }

        async function loadLogs() {
            try {
                const level = document.getElementById('logLevel').value;
                const limit = logsPerPage;
                const offset = currentLogPage * logsPerPage;

                const response = await fetch(`/api/logs?level=${level}&limit=${limit}&offset=${offset}`);
                const data = await response.json();

                const container = document.getElementById('logsContainer');
                container.innerHTML = '';

                if (data.logs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px;">æš«ç„¡æ—¥èªŒ</div>';
                } else {
                    data.logs.forEach(log => {
                        const levelClass = `log-${log.level}`;
                        const html = `
                            <div class="log-entry">
                                <div class="log-time">${new Date(log.timestamp).toLocaleString('zh-TW')}</div>
                                <span class="log-level ${levelClass}">${log.level.toUpperCase()}</span>
                                <span class="log-message">${log.message}</span>
                                ${log.data ? `<div style="color: #cbd5e1; margin-top: 5px;">ğŸ“Œ ${log.data}</div>` : ''}
                            </div>
                        `;
                        container.innerHTML += html;
                    });
                }

                // åˆ†é 
                const totalPages = Math.ceil(data.total / logsPerPage);
                const pagination = document.getElementById('logsPagination');
                pagination.innerHTML = '';

                for (let i = 0; i < totalPages; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i + 1;
                    btn.className = i === currentLogPage ? 'active' : '';
                    btn.onclick = () => {
                        currentLogPage = i;
                        loadLogs();
                    };
                    pagination.appendChild(btn);
                }
            } catch (err) {
                console.error('åŠ è¼‰æ—¥èªŒå¤±æ•—:', err);
            }
        }

        async function clearLogs() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥èªŒå—ï¼Ÿ')) return;
            try {
                await fetch('/api/logs/clear', { method: 'POST' });
                refreshLogs();
                showMessage('æ—¥èªŒå·²æ¸…ç©º', 'success', 'logs');
            } catch (err) {
                showMessage('æ¸…ç©ºæ—¥èªŒå¤±æ•—: ' + err.message, 'error', 'logs');
            }
        }

        async function loadTables() {
            try {
                const env = document.getElementById('dbEnv').value;
                const response = await fetch(`/api/tables/${env}`);
                const data = await response.json();

                const tablesList = document.getElementById('tablesList');
                tablesList.innerHTML = '';

                data.tables.forEach(table => {
                    const btn = document.createElement('button');
                    btn.className = 'button button-secondary';
                    btn.textContent = table;
                    btn.onclick = () => loadTableData(table);
                    tablesList.appendChild(btn);
                });
            } catch (err) {
                showMessage('åŠ è¼‰è¡¨æ ¼å¤±æ•—: ' + err.message, 'error', 'database');
            }
        }

        async function loadTableData(table) {
            try {
                const env = document.getElementById('dbEnv').value;
                const response = await fetch(`/api/table/${env}/${table}?limit=100`);
                const data = await response.json();

                let html = `
                    <h3 style="margin-bottom: 15px;">è¡¨æ ¼: ${table} (å…± ${data.total} è¡Œ)</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    ${data.columns.map(col => `<th>${col.name}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.rows.map(row => `
                                    <tr>
                                        ${data.columns.map(col => `<td>${JSON.stringify(row[col.name])}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('queryResult').innerHTML = html;
            } catch (err) {
                showMessage('åŠ è¼‰è¡¨æ ¼æ•¸æ“šå¤±æ•—: ' + err.message, 'error', 'database');
            }
        }

        async function executeSql() {
            try {
                const env = document.getElementById('dbEnv').value;
                const sql = document.getElementById('sqlQuery').value.trim();

                if (!sql) {
                    showMessage('è«‹è¼¸å…¥ SQL æŸ¥è©¢', 'error', 'database');
                    return;
                }

                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ env, sql })
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('æŸ¥è©¢å¤±æ•—: ' + data.error, 'error', 'database');
                    return;
                }

                let html = `
                    <h3 style="margin-bottom: 15px;">æŸ¥è©¢çµæœ (${data.rowCount} è¡Œ)</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    ${data.fields.map(field => `<th>${field.name}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${data.rows.map(row => `
                                    <tr>
                                        ${data.fields.map(field => `<td>${JSON.stringify(row[field.name])}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('queryResult').innerHTML = html;
                showMessage('æŸ¥è©¢æˆåŠŸ', 'success', 'database');
            } catch (err) {
                showMessage('åŸ·è¡ŒæŸ¥è©¢å¤±æ•—: ' + err.message, 'error', 'database');
            }
        }

        async function loadMigrateTables() {
            try {
                const response = await fetch('/api/tables/offline');
                const data = await response.json();

                const select = document.getElementById('migrateTable');
                select.innerHTML = '<option value="">é¸æ“‡è¡¨æ ¼...</option>';

                data.tables.forEach(table => {
                    const option = document.createElement('option');
                    option.value = table;
                    option.textContent = table;
                    select.appendChild(option);
                });
            } catch (err) {
                showMessage('åŠ è¼‰è¡¨æ ¼å¤±æ•—: ' + err.message, 'error', 'migrate');
            }
        }

        async function migrateTable() {
            const table = document.getElementById('migrateTable').value;
            if (!table) {
                showMessage('è«‹é¸æ“‡è¡¨æ ¼', 'error', 'migrate');
                return;
            }

            if (!confirm(`ç¢ºå®šè¦é·ç§»è¡¨æ ¼ "${table}" å—ï¼Ÿæ­¤æ“ä½œå°‡ä½¿ç”¨å‰ªä¸‹+è²¼ä¸Šæ¨¡å¼ï¼ŒOFFLINE çš„æ•¸æ“šå°‡è¢«åˆªé™¤ï¼ŒONLINE çš„æ•¸æ“šå°‡è¢«ä¿ç•™ä¸¦æ–°å¢ã€‚`)) return;

            try {
                const response = await fetch('/api/migrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table })
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('é·ç§»å¤±æ•—: ' + data.error, 'error', 'migrate');
                    return;
                }

                const resultHtml = `
                    <div class="message message-success">
                        <strong>âœ“ é·ç§»æˆåŠŸï¼ˆå‰ªä¸‹+è²¼ä¸Šæ¨¡å¼ï¼‰ï¼</strong><br>
                        <strong>OFFLINE ç’°å¢ƒï¼š</strong><br>
                        &nbsp;&nbsp;é·ç§»å‰: ${data.offlineRowsBefore} è¡Œ<br>
                        &nbsp;&nbsp;é·ç§»å¾Œ: ${data.offlineRowsAfter} è¡Œ<br>
                        <strong>ONLINE ç’°å¢ƒï¼š</strong><br>
                        &nbsp;&nbsp;é·ç§»å‰: ${data.onlineRowsBefore} è¡Œ<br>
                        &nbsp;&nbsp;é·ç§»å¾Œ: ${data.onlineRowsAfter} è¡Œ<br>
                        <strong>é·ç§»çµæœï¼š</strong><br>
                        &nbsp;&nbsp;æˆåŠŸé·ç§»: ${data.migratedCount} è¡Œ<br>
                        &nbsp;&nbsp;è·³éé‡è¤‡: ${data.duplicateCount} è¡Œ
                    </div>
                `;
                document.getElementById('migrateResult').innerHTML = resultHtml;
                showMessage(data.message, 'success', 'migrate');
                loadMigrateTables();
            } catch (err) {
                showMessage('é·ç§»å¤±æ•—: ' + err.message, 'error', 'migrate');
            }
        }

        async function mergeTable() {
            const table = document.getElementById('migrateTable').value;
            if (!table) {
                showMessage('è«‹é¸æ“‡è¡¨æ ¼', 'error', 'migrate');
                return;
            }

            if (!confirm(`ç¢ºå®šè¦åˆä½µè¡¨æ ¼ "${table}" å—ï¼Ÿæ­¤æ“ä½œå°‡ä¸è¦†è“‹ ONLINE çš„ç¾æœ‰æ•¸æ“šã€‚`)) return;

            try {
                const response = await fetch('/api/merge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table })
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('åˆä½µå¤±æ•—: ' + data.error, 'error', 'migrate');
                    return;
                }

                const resultHtml = `
                    <div class="message message-success">
                        <strong>âœ“ åˆä½µæˆåŠŸï¼</strong><br>
                        OFFLINE å®¢æˆ¶: ${data.offlineCount}<br>
                        ONLINE å®¢æˆ¶(åˆä½µå‰): ${data.onlineCountBefore}<br>
                        æ–°åˆä½µ: ${data.mergedCount}<br>
                        è·³éé‡è¤‡: ${data.duplicateCount}<br>
                        ONLINE å®¢æˆ¶(åˆä½µå¾Œ): ${data.onlineCountAfter}
                    </div>
                `;
                document.getElementById('migrateResult').innerHTML = resultHtml;
                showMessage(data.message, 'success', 'migrate');
                loadMigrateTables();
            } catch (err) {
                showMessage('åˆä½µå¤±æ•—: ' + err.message, 'error', 'migrate');
            }
        }

        async function migrateAll() {
            if (!confirm('ç¢ºå®šè¦é·ç§»æ‰€æœ‰è¡¨æ ¼å—ï¼Ÿé€™å°‡æ¸…ç©º ONLINE ç’°å¢ƒçš„æ‰€æœ‰æ•¸æ“šï¼')) return;

            try {
                document.getElementById('migrateMessage').innerHTML = '<div class="message message-info"><span class="loading"></span> æ­£åœ¨é·ç§»...</div>';

                const response = await fetch('/api/migrate-all', { method: 'POST' });
                const data = await response.json();

                let html = '<h3 style="margin-bottom: 15px;">é·ç§»çµæœ</h3>';
                data.results.forEach(result => {
                    const statusClass = result.status === 'success' ? 'success' : result.status === 'skipped' ? 'info' : 'error';
                    html += `
                        <div class="message message-${statusClass}">
                            <strong>${result.table}</strong>: ${result.status} ${result.rowCount ? `(${result.rowCount} è¡Œ)` : ''} ${result.error ? `- ${result.error}` : ''}
                        </div>
                    `;
                });

                document.getElementById('migrateResult').innerHTML = html;
                showMessage('âœ“ é·ç§»å®Œæˆï¼', 'success', 'migrate');
            } catch (err) {
                showMessage('é·ç§»å¤±æ•—: ' + err.message, 'error', 'migrate');
            }
        }

        async function verifyTable() {
            const table = document.getElementById('migrateTable').value;
            if (!table) {
                showMessage('è«‹é¸æ“‡è¡¨æ ¼', 'error', 'migrate');
                return;
            }

            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table })
                });

                const data = await response.json();

                const statusClass = data.match ? 'success' : 'error';
                const message = data.match 
                    ? `âœ“ æ•¸æ“šå®Œæ•´ï¼OFFLINE: ${data.offlineRows} è¡Œ, ONLINE: ${data.onlineRows} è¡Œ`
                    : `âœ— æ•¸æ“šä¸åŒ¹é…ï¼OFFLINE: ${data.offlineRows} è¡Œ, ONLINE: ${data.onlineRows} è¡Œ`;

                showMessage(message, statusClass, 'migrate');
            } catch (err) {
                showMessage('é©—è­‰å¤±æ•—: ' + err.message, 'error', 'migrate');
            }
        }

        async function verifyAll() {
            try {
                const response = await fetch('/api/tables/offline');
                const data = await response.json();

                document.getElementById('migrateMessage').innerHTML = '<div class="message message-info"><span class="loading"></span> æ­£åœ¨é©—è­‰...</div>';

                let html = '<h3 style="margin-bottom: 15px;">é©—è­‰çµæœ</h3>';
                let allMatch = true;

                for (const table of data.tables) {
                    const verifyResponse = await fetch('/api/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ table })
                    });

                    const verifyData = await verifyResponse.json();
                    const statusClass = verifyData.match ? 'success' : 'error';

                    if (!verifyData.match) allMatch = false;

                    html += `
                        <div class="message message-${statusClass}">
                            <strong>${table}</strong>: ${verifyData.match ? 'âœ“ åŒ¹é…' : 'âœ— ä¸åŒ¹é…'} (OFFLINE: ${verifyData.offlineRows}, ONLINE: ${verifyData.onlineRows})
                        </div>
                    `;
                }

                document.getElementById('migrateResult').innerHTML = html;
                showMessage(allMatch ? 'âœ“ æ‰€æœ‰è¡¨æ ¼é©—è­‰é€šéï¼' : 'âœ— æŸäº›è¡¨æ ¼é©—è­‰å¤±æ•—', allMatch ? 'success' : 'error', 'migrate');
            } catch (err) {
                showMessage('é©—è­‰å¤±æ•—: ' + err.message, 'error', 'migrate');
            }
        }

        function showMessage(msg, type, tab) {
            const msgDiv = document.getElementById(tab + 'Message') || document.getElementById('migrateMessage');
            if (msgDiv) {
                msgDiv.innerHTML = `<div class="message message-${type}">${msg}</div>`;
                setTimeout(() => {
                    msgDiv.innerHTML = '';
                }, 5000);
            }
        }

        // åˆå§‹åŒ–
        loadEnvironments();
        loadMigrateTables();

        // ç›£è½é·ç§»æ¨¡å¼è®ŠåŒ–
        document.querySelectorAll('input[name="migrateMode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('rangeOptions').style.display = this.value === 'range' ? 'block' : 'none';
                document.getElementById('conditionOptions').style.display = this.value === 'condition' ? 'block' : 'none';
            });
        });

        // é è¦½ ID ç¯„åœé·ç§»
        async function previewRangeMigration() {
            const table = document.getElementById('migrateTable').value;
            const idFrom = parseInt(document.getElementById('idFrom').value);
            const idTo = parseInt(document.getElementById('idTo').value);

            if (!table || isNaN(idFrom) || isNaN(idTo)) {
                showMessage('è«‹å¡«å¯«å®Œæ•´çš„åƒæ•¸', 'error', 'migrate');
                return;
            }

            try {
                const response = await fetch('/api/preview-migrate-range', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table, idFrom, idTo })
                });

                const data = await response.json();
                document.getElementById('rangePreview').textContent = `å°‡é·ç§» ${data.rowCount} è¡Œ`;
            } catch (err) {
                showMessage('é è¦½å¤±æ•—: ' + err.message, 'error', 'migrate');
            }
        }

        // é è¦½æ¢ä»¶é·ç§»
        async function previewConditionMigration() {
            const table = document.getElementById('migrateTable').value;
            const condition = document.getElementById('condition').value;

            if (!table || !condition) {
                showMessage('è«‹å¡«å¯«å®Œæ•´çš„åƒæ•¸', 'error', 'migrate');
                return;
            }

            try {
                const response = await fetch('/api/preview-migrate-condition', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table, condition })
                });

                const data = await response.json();
                document.getElementById('conditionPreview').textContent = `å°‡é·ç§» ${data.rowCount} è¡Œ`;
            } catch (err) {
                showMessage('é è¦½å¤±æ•—: ' + err.message, 'error', 'migrate');
            }
        }

        // åŸ·è¡Œéƒ¨åˆ†é·ç§»
        async function partialMigrateTable() {
            const table = document.getElementById('migrateTable').value;
            const mode = document.querySelector('input[name="migrateMode"]:checked').value;

            if (!table) {
                showMessage('è«‹é¸æ“‡è¡¨æ ¼', 'error', 'migrate');
                return;
            }

            if (mode === 'full') {
                showMessage('è«‹é¸æ“‡éƒ¨åˆ†é·ç§»æ¨¡å¼ï¼ˆID ç¯„åœæˆ–æ¢ä»¶ï¼‰', 'error', 'migrate');
                return;
            }

            let endpoint, body, confirmMsg;

            if (mode === 'range') {
                const idFrom = parseInt(document.getElementById('idFrom').value);
                const idTo = parseInt(document.getElementById('idTo').value);

                if (isNaN(idFrom) || isNaN(idTo)) {
                    showMessage('è«‹å¡«å¯« ID ç¯„åœ', 'error', 'migrate');
                    return;
                }

                endpoint = '/api/migrate-range';
                body = { table, idFrom, idTo };
                confirmMsg = `ç¢ºå®šè¦é·ç§»è¡¨æ ¼ "${table}" çš„ ID ${idFrom}-${idTo} å—ï¼Ÿ`;
            } else if (mode === 'condition') {
                const condition = document.getElementById('condition').value;

                if (!condition) {
                    showMessage('è«‹å¡«å¯« SQL æ¢ä»¶', 'error', 'migrate');
                    return;
                }

                endpoint = '/api/migrate-condition';
                body = { table, condition };
                confirmMsg = `ç¢ºå®šè¦é·ç§»è¡¨æ ¼ "${table}" ç¬¦åˆæ¢ä»¶çš„æ•¸æ“šå—ï¼Ÿ\næ¢ä»¶: ${condition}`;
            }

            if (!confirm(confirmMsg)) return;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('éƒ¨åˆ†é·ç§»å¤±æ•—: ' + data.error, 'error', 'migrate');
                    return;
                }

                const resultHtml = `
                    <div class="message message-success">
                        <strong>âœ“ éƒ¨åˆ†é·ç§»æˆåŠŸï¼</strong><br>
                        <strong>OFFLINE ç’°å¢ƒï¼š</strong><br>
                        &nbsp;&nbsp;é·ç§»å‰: ${data.offlineRowsBefore} è¡Œ<br>
                        &nbsp;&nbsp;é·ç§»å¾Œ: ${data.offlineRowsAfter} è¡Œ<br>
                        <strong>ONLINE ç’°å¢ƒï¼š</strong><br>
                        &nbsp;&nbsp;é·ç§»å‰: ${data.onlineRowsBefore} è¡Œ<br>
                        &nbsp;&nbsp;é·ç§»å¾Œ: ${data.onlineRowsAfter} è¡Œ<br>
                        <strong>é·ç§»çµæœï¼š</strong><br>
                        &nbsp;&nbsp;æˆåŠŸé·ç§»: ${data.migratedCount} è¡Œ<br>
                        &nbsp;&nbsp;è·³éé‡è¤‡: ${data.duplicateCount} è¡Œ
                    </div>
                `;
                document.getElementById('migrateResult').innerHTML = resultHtml;
                showMessage(data.message, 'success', 'migrate');
                loadMigrateTables();
            } catch (err) {
                showMessage('éƒ¨åˆ†é·ç§»å¤±æ•—: ' + err.message, 'error', 'migrate');
            }
        }

        // ===== å®¢æˆ¶é¸æ“‡å’Œé·ç§»åŠŸèƒ½ =====
        
        // åŠ è¼‰å®¢æˆ¶åˆ—è¡¨
        async function loadCustomerList() {
            try {
                const database = document.getElementById('selectDatabase').value;
                const tbody = document.getElementById('customerTableBody');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">åŠ è¼‰ä¸­...</td></tr>';
                
                const response = await fetch('/api/get-table-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table: 'customers', database })
                });
                const result = await response.json();
                
                if (!result.success) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">éŒ¯èª¤: ${result.error}</td></tr>`;
                    return;
                }
                
                tbody.innerHTML = '';
                result.data.forEach(customer => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #eee';
                    row.innerHTML = `
                        <td style="padding: 10px;"><input type="checkbox" class="customerCheckbox" value="${customer.id}" onchange="updateSelectedCount()"></td>
                        <td style="padding: 10px;">${customer.id}</td>
                        <td style="padding: 10px;">${customer.name || '-'}</td>
                        <td style="padding: 10px;">${customer.email || '-'}</td>
                        <td style="padding: 10px;">${customer.company || '-'}</td>
                        <td style="padding: 10px;">${customer.status || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('customerListContainer').style.display = 'block';
                updateSelectedCount();
            } catch (err) {
                console.error('åŠ è¼‰å®¢æˆ¶åˆ—è¡¨å¤±æ•—:', err);
                const tbody = document.getElementById('customerTableBody');
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">éŒ¯èª¤: ${err.message}</td></tr>`;
            }
        }

        // å…¨é¸
        function selectAllCustomers() {
            try {
                document.querySelectorAll('.customerCheckbox').forEach(cb => cb.checked = true);
                updateSelectedCount();
            } catch (err) {
                console.error('å…¨é¸å¤±æ•—:', err);
            }
        }

        // åé¸
        function deselectAllCustomers() {
            try {
                document.querySelectorAll('.customerCheckbox').forEach(cb => cb.checked = false);
                updateSelectedCount();
            } catch (err) {
                console.error('åé¸å¤±æ•—:', err);
            }
        }

        // æ›´æ–°é¸ä¸­è¨ˆæ•¸
        function updateSelectedCount() {
            try {
                const count = document.querySelectorAll('.customerCheckbox:checked').length;
                const countElement = document.getElementById('selectedCount');
                if (countElement) {
                    countElement.textContent = `å·²é¸æ“‡: ${count} å€‹å®¢æˆ¶`;
                }
            } catch (err) {
                console.error('æ›´æ–°è¨ˆæ•¸å¤±æ•—:', err);
            }
        }

        // ç²å–é¸ä¸­çš„ ID
        function getSelectedIds() {
            try {
                return Array.from(document.querySelectorAll('.customerCheckbox:checked')).map(cb => parseInt(cb.value));
            } catch (err) {
                console.error('ç²å–é¸ä¸­ ID å¤±æ•—:', err);
                return [];
            }
        }

        // é·ç§»é¸ä¸­çš„å®¢æˆ¶
        async function migrateSelectedCustomers() {
            try {
                const ids = getSelectedIds();
                if (ids.length === 0) {
                    alert('è«‹å…ˆé¸æ“‡å®¢æˆ¶');
                    return;
                }
                
                if (!confirm(`ç¢ºèªé·ç§» ${ids.length} å€‹å®¢æˆ¶å—ï¼Ÿ\n\nOFFLINE çš„æ•¸æ“šå°‡è¢«åˆªé™¤ï¼ŒONLINE å°‡å¢åŠ é€™äº›å®¢æˆ¶ã€‚`)) {
                    return;
                }
                
                const resultDiv = document.getElementById('selectResult');
                resultDiv.innerHTML = '<p style="color: #666;">é·ç§»ä¸­...</p>';
                
                const response = await fetch('/api/migrate-by-ids', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table: 'customers', ids })
                });
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; padding: 15px; color: #155724;">
                            <strong>âœ“ ${result.message}</strong><br>
                            OFFLINE: ${result.offlineRowsBefore} â†’ ${result.offlineRowsAfter}<br>
                            ONLINE: ${result.onlineRowsBefore} â†’ ${result.onlineRowsAfter}
                        </div>
                    `;
                    setTimeout(() => loadCustomerList(), 2000);
                } else {
                    resultDiv.innerHTML = `<div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 15px; color: #721c24;"><strong>âœ— éŒ¯èª¤: ${result.error}</strong></div>`;
                }
            } catch (err) {
                console.error('é·ç§»å¤±æ•—:', err);
                const resultDiv = document.getElementById('selectResult');
                resultDiv.innerHTML = `<div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 15px; color: #721c24;"><strong>âœ— éŒ¯èª¤: ${err.message}</strong></div>`;
            }
        }

        // åˆä½µé¸ä¸­çš„å®¢æˆ¶
        async function mergeSelectedCustomers() {
            try {
                const ids = getSelectedIds();
                if (ids.length === 0) {
                    alert('è«‹å…ˆé¸æ“‡å®¢æˆ¶');
                    return;
                }
                
                if (!confirm(`ç¢ºèªåˆä½µ ${ids.length} å€‹å®¢æˆ¶å—ï¼Ÿ\n\nOFFLINE çš„æ•¸æ“šå°‡ä¿ç•™ï¼ŒONLINE å°‡å¢åŠ é€™äº›å®¢æˆ¶ã€‚`)) {
                    return;
                }
                
                const resultDiv = document.getElementById('selectResult');
                resultDiv.innerHTML = '<p style="color: #666;">åˆä½µä¸­...</p>';
                
                const response = await fetch('/api/merge-by-ids', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ table: 'customers', ids })
                });
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; padding: 15px; color: #155724;">
                            <strong>âœ“ ${result.message}</strong><br>
                            OFFLINE: ${result.offlineRowsBefore} (ä¿ç•™)<br>
                            ONLINE: ${result.onlineRowsBefore} â†’ ${result.onlineRowsAfter}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 15px; color: #721c24;"><strong>âœ— éŒ¯èª¤: ${result.error}</strong></div>`;
                }
            } catch (err) {
                console.error('åˆä½µå¤±æ•—:', err);
                const resultDiv = document.getElementById('selectResult');
                resultDiv.innerHTML = `<div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 15px; color: #721c24;"><strong>âœ— éŒ¯èª¤: ${err.message}</strong></div>`;
            }
        }
    </script>
</body>
</html>
